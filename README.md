# Xiaomi dipper PostmarketOS

## 0. Clone the repositories
```shell
cd ~
git clone https://github.com/evil-hero/postmarketos.git
```

## 1. Install pmbootstrap
```shell
cd ~/postmarketos
git clone --depth=1 https://gitlab.com/postmarketOS/pmbootstrap.git
mkdir -p ~/.local/bin
ln -s "$PWD/pmbootstrap/pmbootstrap.py" ~/.local/bin/pmbootstrap
```

## 2. pmbootstrap init
```shell
pmbootstrap init
```

## 3. Update config
```shell
rm -rf ~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/linux-xiaomi-dipper
rm -rf ~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/device-xiaomi-dipper
mv ~/postmarketos/linux-xiaomi-dipper ~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/
mv ~/postmarketos/device-xiaomi-dipper ~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/
mv ~/postmarketos/firmware-xiaomi-dipper ~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/
```

## 4. Build linux
### You should fix the warnings generated by kconfig yourself.
```shell
cd ~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/linux-xiaomi-dipper
pmbootstrap checksum linux-xiaomi-dipper
pmbootstrap kconfig edit
pmbootstrap -j8 build linux-xiaomi-dipper
```
Open a new terminal and execute `pmbootstrap log` to view the log.

## 5. Build device
### When building the device, the firmware is automatically built.
```shell
cd ~/.local/var/pmbootstrap/cache_git/pmaports/device/testing/device-xiaomi-dipper
pmbootstrap checksum device-xiaomi-dipper
pmbootstrap build device-xiaomi-dipper
```

## 6. Install
### To install to the system partition of an image file:
```shell
pmbootstrap install
```
### Or create an Android recovery zip package:
```shell
pmbootstrap install --android-recovery-zip --recovery-install-partition=data
pmbootstrap flasher --method=adb sideload
```
### Export
```shell
pmbootstrap export
cd $(dirname $(readlink /tmp/postmarketOS-export/pmos-*.zip))
adb sideload pmos-xiaomi-dipper.zip
```

## 7. Flash
```shell
pmbootstrap flasher flash_rootfs --partition userdata
```
### If you have a device that works with fastboot, you can boot the kernel now without flashing it:
```shell
pmbootstrap flasher boot
```
### Otherwise, you will need to flash the kernel to the device boot partition:
```shell
pmbootstrap flasher flash_kernel
```

